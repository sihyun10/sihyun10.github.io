<!-- https://utteranc.es/ -->
<div id="utterances"></div>

<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function () {
    const origin = 'https://utteranc.es';
    const lightTheme = 'github-light';
    const darkTheme = 'github-dark';
    let initTheme = lightTheme;
    const html = document.documentElement;

    // 초기 테마 결정
    if (
      (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') ||
      (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      initTheme = darkTheme;
    }

    // utterances script 생성 및 삽입
    let s = document.createElement('script');
    s.src = 'https://utteranc.es/client.js';
    s.setAttribute('repo', '{{ site.comments.utterances.repo }}');
    s.setAttribute('issue-term', '{{ site.comments.utterances.issue_term }}');
    s.setAttribute('theme', initTheme);
    s.setAttribute('crossorigin', 'anonymous');
    s.async = true;

    document.getElementById('utterances').appendChild(s);

    // 다크모드 전환 이벤트 처리
    window.addEventListener('message', (event) => {
      if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
        const theme = event.data.message === ModeToggle.DARK_MODE ? darkTheme : lightTheme;
        const iframe = document.querySelector('iframe.utterances-frame');
        if (iframe) {
          iframe.contentWindow.postMessage({ type: 'set-theme', theme }, origin);
        }
      }
    });
  });
</script>
