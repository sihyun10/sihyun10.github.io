---
title: "Pintos Project 2 : System Calls (1)"
date: 2025-05-25 23:04:00 +09:00
categories: [KraftonJungle]
tags: [jungle]
pin: false
---

Pintos Project 2ì˜ `argument_passing` êµ¬í˜„ì— ì´ì–´ì„œ `User Memory Access`íŒŒíŠ¸ë¡œ ì™”ë‹¤.  
ì´ ë¶€ë¶„ì€ ì‹œìŠ¤í…œ ì½œ êµ¬í˜„ì— ìžˆì–´ì„œ ì‚¬ìš©ìž ë©”ëª¨ë¦¬ ê³µê°„ì— ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì„ ì•ˆì „í•˜ê²Œ êµ¬í˜„í•´ì•¼í•˜ëŠ” íŒŒíŠ¸ì´ë‹¤.

### User Memory Access

ì‹œìŠ¤í…œ ì½œì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” ì‚¬ìš©ìž ê°€ìƒ ì£¼ì†Œ ê³µê°„ì˜ ë°ì´í„°ë¥¼ ì½ê³  ì“°ëŠ” ë°©ë²•ì„ ì œê³µí•´ì•¼í•œë‹¤.  
ì‹œìŠ¤í…œ ì½œì˜ ì¸ìžë¥¼ ê°€ì ¸ì˜¬ ë•ŒëŠ” ì´ ê¸°ëŠ¥ì´ ê¼­ í•„ìš”í•˜ì§€ ì•Šë‹¤.  
í•˜ì§€ë§Œ ì‹œìŠ¤í…œ ì½œ ì¸ìžë¡œ ì£¼ì–´ì§„ í¬ì¸í„°ì—ì„œ ë°ì´í„°ë¥¼ **ì½ì„ ë•Œ**ëŠ” ë°˜ë“œì‹œ ì´ ê¸°ëŠ¥ì„ í†µí•´ í”„ë¡ì‹œí•´ì•¼í•œë‹¤.  
ì´ê±´ ì•½ê°„ ê¹Œë‹¤ë¡œìš¸ ìˆ˜ ìžˆë‹¤. ë§Œì•½ ì‚¬ìš©ìžê°€ ìž˜ëª»ëœ í¬ì¸í„°, ì»¤ë„ ë©”ëª¨ë¦¬ë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°, í•´ë‹¹ ì˜ì—­ ì¤‘ í•˜ë‚˜ì— ë¶€ë¶„ì ìœ¼ë¡œ ë¸”ë¡ì„ ìž…ë ¥í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?  
ì´ëŸ° ê²½ìš°ì—ëŠ” í•´ë‹¹ ì‚¬ìš©ìž í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œì‹œì¼œì•¼ í•œë‹¤.

ì°¸ê³  : [pintos_project2_introductionì—ì„œ Accessing User Memory íŒŒíŠ¸ ë¶€ë¶„](https://sihyun10.github.io/posts/pintos_project2_intro/#accessing-user-memory---%EC%82%AC%EC%9A%A9%EC%9E%90-%EB%A9%94%EB%AA%A8%EB%A6%AC%EC%97%90-%EC%A0%91%EA%B7%BC%ED%95%98%EA%B8%B0)

---

### System Calls

ì‹œìŠ¤í…œ ì½œ ì¸í”„ë¼(ê¸°ë°˜ êµ¬ì¡°)ë¥¼ êµ¬í˜„í•´ë¼.  
`userprog/syscall.c` íŒŒì¼ì— ì‹œìŠ¤í…œ ì½œ í•¸ë“¤ëŸ¬ë¥¼ êµ¬í˜„í•˜ì‹œì˜¤.  
ìš°ë¦¬ê°€ ì œê³µí•˜ëŠ” ê¸°ë³¸ êµ¬í˜„ì€ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí•˜ì—¬ ì‹œìŠ¤í…œ ì½œì„ ì²˜ë¦¬í•œë‹¤.  
ì‹œìŠ¤í…œ ì½œ ë²ˆí˜¸ë¥¼ ë¨¼ì € ê°€ì ¸ì˜¨ ë‹¤ìŒ, ì‹œìŠ¤í…œ ì½œ ì¸ìžë“¤ì„ ì½ì–´ì˜¤ê³ , ì•Œë§žì€ ìž‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•œë‹¤.

#### System Call Details

ì²«ë²ˆì§¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” ìš´ì˜ì²´ì œê°€ ì‚¬ìš©ìž í”„ë¡œê·¸ëž¨ìœ¼ë¡œë¶€í„° ì œì–´ê¶Œì„ ë‹¤ì‹œ ì–»ëŠ” í•œ ê°€ì§€ ë°©ë²•ì¸,  
íƒ€ì´ë¨¸ì™€ I/O ìž¥ì¹˜ì—ì„œ ë°œìƒí•˜ëŠ” ì¸í„°ëŸ½íŠ¸ë¥¼ ë‹¤ë¤˜ì—ˆë‹¤.  
ì´ëŸ¬í•œ ì¸í„°ëŸ½íŠ¸ëŠ” CPU ì™¸ë¶€ì˜ ìž¥ì¹˜ì— ì˜í•´ ë°œìƒí•˜ë¯€ë¡œ **ì™¸ë¶€ ì¸í„°ëŸ½íŠ¸**(`external interrupt`)ë¼ê³  ë¶€ë¥¸ë‹¤.

ìš´ì˜ì²´ì œëŠ” í”„ë¡œê·¸ëž¨ ì½”ë“œì—ì„œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ì¸ **ì†Œí”„íŠ¸ì›¨ì–´ ì˜ˆì™¸**(`software exception`)ë„ ì²˜ë¦¬í•œë‹¤.  
ì˜ˆì™¸ëŠ” **page fault**(íŽ˜ì´ì§€ í´íŠ¸) ë˜ëŠ” **0ìœ¼ë¡œ ë‚˜ëˆ„ê¸°** ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.  
ì˜ˆì™¸ëŠ” ì‚¬ìš©ìž í”„ë¡œê·¸ëž¨ì´ ìš´ì˜ì²´ì œì—ê²Œ **ì‹œìŠ¤í…œ ì½œ**ì„ ìš”ì²­í•˜ëŠ” ìˆ˜ë‹¨ì´ê¸°ë„ í•œë‹¤!

ì „í†µì ì¸ `x86` ì•„í‚¤í…ì²˜ì—ì„œëŠ” ì‹œìŠ¤í…œ ì½œì´ ë‹¤ë¥¸ ì†Œí”„íŠ¸ì›¨ì–´ ì˜ˆì™¸ì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬ë˜ì—ˆë‹¤.  
ê·¸ëŸ¬ë‚˜ `x86-64`ì—ì„œëŠ” ì œì¡°ì‚¬ë“¤ì´ ì‹œìŠ¤í…œ ì½œ ì „ìš© ëª…ë ¹ì–´ì¸ `syscall`ì„ ë„ìž…í–ˆë‹¤.  
ì´ê²ƒì€ ì‹œìŠ¤í…œ ì½œ í•¸ë“¤ëŸ¬ë¥¼ ë¹ ë¥´ê²Œ í˜¸ì¶œí•˜ëŠ” ë°©ë²•ì„ ì œê³µí•œë‹¤.

ìš”ì¦˜ì€ `x86-64`ì—ì„œ ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ëŠ” ë°ì— `syscall` ëª…ë ¹ì–´ê°€ ê°€ìž¥ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.  
Pintosì—ì„œëŠ” ì‚¬ìš©ìž í”„ë¡œê·¸ëž¨ì´ ì‹œìŠ¤í…œ ì½œì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ `syscall` ëª…ë ¹ì–´ë¥¼ í˜¸ì¶œí•œë‹¤.  
ì‹œìŠ¤í…œ ì½œ ë²ˆí˜¸ì™€ ì¶”ê°€ ì¸ìžë“¤ì€ ì¼ë°˜ì ì¸ ê·œì¹™ì— ë”°ë¼ ë ˆì§€ìŠ¤í„°ì— ì €ìž¥ëœ ë’¤, `syscall` ëª…ë ¹ì–´ë¥¼ í˜¸ì¶œí•´ì•¼í•œë‹¤.  
ë‹¨, ì˜ˆì™¸ ì‚¬í•­ì´ 2ê°€ì§€ ìžˆë‹¤.

- `%rax`ëŠ” **ì‹œìŠ¤í…œ ì½œ ë²ˆí˜¸**ì´ë‹¤.
- 4ë²ˆì§¸ ì¸ìžëŠ” `%rcx`ê°€ ì•„ë‹ˆë¼, `%r10`ì— ë“¤ì–´ê°„ë‹¤.

ë”°ë¼ì„œ ì‹œìŠ¤í…œ ì½œ í•¸ë“¤ëŸ¬ì¸ `syscall_handler()`ê°€ ì œì–´ë¥¼ ë„˜ê²¨ë°›ì„ ë•Œ,  
ì‹œìŠ¤í…œ ì½œ ë²ˆí˜¸ëŠ” `rax`ì— ìžˆê³ , ì¸ìžë“¤ì€ `%rdi`, `%rsi`, `%rdx`, `%r10`, `%r8`, `%r9` ìˆœì„œë¡œ ì „ë‹¬ëœë‹¤.

í˜¸ì¶œìžì˜ ë ˆì§€ìŠ¤í„° ê°’ë“¤ì€ `struct intr_frame`ì„ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìžˆë‹¤.  
(`struct intr_frame`ì€ ì»¤ë„ ìŠ¤íƒì— ì¡´ìž¬í•œë‹¤)

`x86-64`ì—ì„œëŠ” í•¨ìˆ˜ì˜ ë°˜í™˜ê°’ì„ `RAX` ë ˆì§€ìŠ¤í„°ì— ì €ìž¥í•˜ëŠ” ê²ƒì´ ê´€ë¡€ì´ë‹¤.  
ë°˜í™˜ê°’ì´ ìžˆëŠ” ì‹œìŠ¤í…œ ì½œì€ `struct intr_frame`ì˜ `rax` ë©¤ë²„ë¥¼ ìˆ˜ì •í•´ì„œ ê°’ì„ ë°˜í™˜í•  ìˆ˜ ìžˆë‹¤.

---

### Implement the following system calls - ë‹¤ìŒì˜ ì‹œìŠ¤í…œ ì½œë“¤ì„ êµ¬í˜„í•´ë¼!

ìœ ì € í”„ë¡œê·¸ëž¨ì—ì„œ ì‹œìŠ¤í…œ ì½œì„ ì‚¬ìš©í•  ìˆ˜ ìžˆë„ë¡ ì •ì˜ëœ ì¸í„°íŽ˜ì´ìŠ¤ í—¤ë”ëŠ” `include/lib/user/syscall.h` ì—¬ê¸°ì— ì •ì˜ë˜ì–´ìžˆë‹¤.  
ì´ í—¤ë” íŒŒì¼(ê·¸ë¦¬ê³  `include/lib/user` ì•ˆì˜ ë‹¤ë¥¸ ëª¨ë“  í—¤ë” íŒŒì¼ë“¤)ì€ ìœ ì € í”„ë¡œê·¸ëž¨ë§Œì„ ìœ„í•œ ê²ƒì´ë‹¤.  
ê°ê°ì˜ ì‹œìŠ¤í…œ ì½œì— ëŒ€í•œ ê³ ìœ í•œ ë²ˆí˜¸ëŠ” `include/lib/syscall-nr.h` íŒŒì¼ì— ì •ì˜ë˜ì–´ìžˆë‹¤.

### halt()

```c
void halt (void);
```

`power_off()`ë¥¼ í˜¸ì¶œí•˜ì—¬ Pintosë¥¼ ì¢…ë£Œí•œë‹¤.  
(ì´ í•¨ìˆ˜ëŠ” `src/include/threads/init.h`ì— ì„ ì–¸ë˜ì–´ ìžˆë‹¤.)  
ì´ í•¨ìˆ˜ëŠ” ê°€ëŠ¥í•œ í•œ ê±°ì˜ ì‚¬ìš©í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.  
ì™œëƒí•˜ë©´ ì´ë¥¼ í˜¸ì¶œí•˜ë©´ ë°ë“œë½(êµì°© ìƒíƒœ)ê³¼ ê°™ì€ ë¬¸ì œ ìƒí™©ì— ëŒ€í•œ ì •ë³´ë¥¼ ìžƒê²Œ ë  ìˆ˜ ìžˆê¸° ë•Œë¬¸ì´ë‹¤.

#### **[êµ¬í˜„]**

```c
#include "threads/init.h" // power_off() ì‚¬ìš©í•˜ê¸° ìœ„í•´

void halt(void)
{
  power_off();
}
```

```c
// syscall_handler()ì— ì¶”ê°€
  case SYS_HALT:
    halt();
    break;
```

---

### exit()

```c
void exit (int status);
```

í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ ìœ ì € í”„ë¡œê·¸ëž¨ì„ ì¢…ë£Œì‹œí‚¤ê³ ,  
`status` ê°’ì„ ì»¤ë„ì— ë°˜í™˜í•œë‹¤.  
ë§Œì•½ ì´ í”„ë¡œì„¸ìŠ¤ì˜ ë¶€ëª¨ê°€ ìžì‹ì˜ ì¢…ë£Œë¥¼ ê¸°ë‹¤ë¦¬ê³  ìžˆë‹¤ë©´,  
í•´ë‹¹ ë¶€ëª¨ëŠ” ì´ `status` ê°’ì„ ë°˜í™˜ë°›ê²Œ ëœë‹¤.  
ê´€ë¡€ì ìœ¼ë¡œ `0`ì€ ì„±ê³µì„, **0ì´ ì•„ë‹Œ ê°’**ì€ ì—ëŸ¬ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.

#### **[êµ¬í˜„]**

`exit_status`ë¥¼ `thread` êµ¬ì¡°ì²´ì— í•„ë“œë¡œ ì¶”ê°€í•´ì¤€ë‹¤.  
ìžì‹ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œëœ ë’¤, ì¢…ë£Œ ìƒíƒœë¥¼ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì—ê²Œ ì•Œë ¤ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

```c
// include/threads/thread.h
#ifdef USERPROG
  /* Owned by userprog/process.c. */
  uint64_t *pml4; /* Page map level 4 */
  int exit_status;
```

```c
void exit(int status)
{
  struct thread *curr = thread_current();
  curr->exit_status = status;
  printf("%s: exit(%d)\n", curr->name, curr->exit_status);
  thread_exit();
}
```

í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ ìŠ¤ë ˆë“œ(í”„ë¡œì„¸ìŠ¤)ë¥¼ ê°€ì ¸ì˜¨ í›„ì—  
ì¢…ë£Œ ìƒíƒœ ì½”ë“œë¥¼ í˜„ìž¬ ìŠ¤ë ˆë“œì— ì €ìž¥í•œë‹¤.  
ì¢…ë£Œ ë¡œê·¸ ì¶œë ¥í•˜ê³ , í˜„ìž¬ ìŠ¤ë ˆë“œ(í”„ë¡œì„¸ìŠ¤)ë¥¼ ì¢…ë£Œí•œë‹¤.

```c
// syscall_handler()ì— ì¶”ê°€
  case SYS_EXIT:
    exit((int)f->R.rdi);
    break;
```

---

### create()

```c
bool create (const char *file, unsigned initial_size);
```

`file`ì´ë¼ëŠ” ì´ë¦„ì˜ ìƒˆë¡œìš´ íŒŒì¼ì„ ìƒì„±í•˜ë©°, ì´ íŒŒì¼ì˜ ì´ˆê¸° í¬ê¸°ëŠ” `initial_size` ë°”ì´íŠ¸ì´ë‹¤.  
íŒŒì¼ ìƒì„±ì— ì„±ê³µí•˜ë©´ `true`ë¥¼ ë°˜í™˜í•˜ê³ , ì‹¤íŒ¨í•˜ë©´ `false`ë¥¼ ë°˜í™˜í•œë‹¤.  
íŒŒì¼ì„ ìƒˆë¡œ ìƒì„±í•˜ëŠ” ìž‘ì—…ì€ íŒŒì¼ì„ ì—¬ëŠ” ìž‘ì—…ê³¼ëŠ” ë‹¤ë¥´ë‹¤.  
ìƒˆë¡œ ìƒì„±ëœ íŒŒì¼ì„ ì—´ê¸° ìœ„í•´ì„œëŠ” ë³„ë„ì˜ `open` ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•´ì•¼í•œë‹¤.

#### **[êµ¬í˜„]**

```c
#include "filesys/filesys.h"
#include "threads/vaddr.h"

static void check_address(const void *addr)
{
  if (is_kernel_vaddr(addr) || addr == NULL)
    exit(-1);

  if (pml4_get_page(thread_current()->pml4, addr) == NULL)
    exit(-1);
}

bool create(const char *file, unsigned initial_size)
{
  check_address(file);
  return filesys_create(file, initial_size);
}
```

`create()` ì‹œìŠ¤í…œ ì½œì€ ì‚¬ìš©ìž í”„ë¡œê·¸ëž¨ì´ ìš”ì²­í•œ ì´ë¦„, í¬ê¸°ë¡œ ìƒˆë¡œìš´ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.  
`check_address()`ìœ¼ë¡œ í™•ì¸í•œ ë’¤, íŒŒì¼ì„ ìƒì„±í•œë‹¤.

- `check_address(const void *addr)`
  - ì»¤ë„ ì£¼ì†Œì¸ì§€ ì²´í¬
  - ì£¼ì†Œê°€ NULLì¸ì§€ ì²´í¬
  - í˜„ìž¬ í”„ë¡œì„¸ìŠ¤ì˜ íŽ˜ì´ì§€ í…Œì´ë¸”ì— ë§¤í•‘ë˜ì–´ìžˆëŠ”ì§€ í™•ì¸

```c
// syscall_handler()ì— ì¶”ê°€
  case SYS_CREATE:
    f->R.rax = create(f->R.rdi, f->R.rsi);
    break;
```

#### (ì°¸ê³ )

```c
int process_wait(tid_t child_tid UNUSED)
{
  for (int i = 0; i < 600000000; i++)
  {
  }
  return -1;
}
```

`500000000` âž” `600000000`ìœ¼ë¡œ ìˆ«ìžë¥¼ ì¦ê°€ì‹œì¼°ë‹¤.  
ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ê°€ ìžì‹ í”„ë¡œì„¸ìŠ¤ê°€ ì™„ì „ížˆ ì¢…ë£Œë˜ê¸° ì „ì— ë¨¼ì € ì£½ì„ ìˆ˜ ìžˆê¸°ì—  
ì—¬ìœ ë¡œìš´ ì‹œê°„ì„ ì œê³µí•´ì£¼ì–´ì•¼í•˜ëŠ”ë°, `500000000`ì€ ìˆ«ìžê°€ ì ì—ˆë‚˜ë³´ë‹¤.  
ì´ë ‡ê²Œ ë°”ê¿”ì£¼ë‹ˆ í…ŒìŠ¤íŠ¸ í†µê³¼ê°€ ë˜ì—ˆë‹¤.

---

### remove()

```c
bool remove (const char *file);
```

`file`ì´ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì„ ì‚­ì œí•œë‹¤.  
ì‚­ì œì— ì„±ê³µí•˜ë©´ `true`ë¥¼, ì‹¤íŒ¨í•˜ë©´ `false`ë¥¼ ë°˜í™˜í•œë‹¤.  
íŒŒì¼ì´ ì—´ë ¤ ìžˆë“  ë‹«í˜€ ìžˆë“  ê´€ê³„ì—†ì´ ì‚­ì œê°€ ê°€ëŠ¥í•˜ë‹¤.  
ì—´ë ¤ ìžˆëŠ” íŒŒì¼ì„ ì‚­ì œí•´ë„, ê·¸ íŒŒì¼ì„ ì¦‰ì‹œ ë‹«ì§€ëŠ” ì•ŠëŠ”ë‹¤.

> ðŸ§ **ì—´ë¦° íŒŒì¼ì´ ì‚­ì œë˜ë©´ ì–´ë–¤ ì¼ì´ ë°œìƒí• ê¹Œ?**
>
> - íŒŒì¼ì— ëŒ€í•´ í‘œì¤€ Unix ì˜ë¯¸ë¡ (ë™ìž‘ ë°©ì‹)ì„ êµ¬í˜„í•´ì•¼ í•œë‹¤
> - ì–´ë–¤ íŒŒì¼ì´ ì‚­ì œë˜ë”ë¼ë„ ê·¸ íŒŒì¼ì— ëŒ€í•œ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ ì´ë¯¸ ê°€ì§€ê³  ìžˆëŠ” í”„ë¡œì„¸ìŠ¤ëŠ”  
>   **ê³„ì† ê·¸ ë””ìŠ¤í¬ë¦½í„°ë¥¼ ì‚¬ìš©**í•  ìˆ˜ ìžˆë‹¤
> - ì¦‰, í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ëŠ” ê·¸ íŒŒì¼ì— ê³„ì†í•´ì„œ ì½ê¸°ë‚˜ ì“°ê¸° ìž‘ì—…ì„ í•  ìˆ˜ ìžˆë‹¤
> - íŒŒì¼ì€ ì´ë¦„ì„ ìžƒê²Œ ë˜ê³ , ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ëŠ” ë” ì´ìƒ ê·¸ íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ê²Œ ëœë‹¤
> - í•˜ì§€ë§Œ ê·¸ íŒŒì¼ì„ ê°€ë¦¬í‚¤ëŠ” ëª¨ë“  íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ê°€ ë‹«ížˆê±°ë‚˜, ì‹œìŠ¤í…œì´ ì¢…ë£Œë  ë•Œê¹Œì§€,  
>    í•´ë‹¹ íŒŒì¼ì€ ê³„ì† ì¡´ìž¬í•œë‹¤
>   {: .prompt-tip }

#### **[êµ¬í˜„]**

```c
bool remove(const char *file)
{
  check_string(file);
  return filesys_remove(file);
}
```

`remove()` ì‹œìŠ¤í…œ ì½œì€ ì£¼ì–´ì§„ **ì´ë¦„**ì˜ íŒŒì¼ì„ ì°¾ì•„ì„œ ì œê±°í•œë‹¤.  
ì‹¤ì œ ì‚­ì œë˜ëŠ”ê±´ ì•„ë‹ˆë‹¤!

```c
// syscall_handler()ì— ì¶”ê°€
  case SYS_REMOVE:
    f->R.rax = remove(f->R.rdi);
    break;
```
